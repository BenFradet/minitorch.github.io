
<!DOCTYPE html>

<html lang="english">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parallel Computation &#8212; MiniTorch 0.1 documentation</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="_static/thebelab.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Fusing Operations" href="matrixmult.html" />
    <link rel="prev" title="Module 3 - Efficiency" href="module3.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="index.html">
<p class="title">MiniTorch</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="setup.html">
  Workspace Setup
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="contributing.html">
  Contributing
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="mlprimer.html">
  ML Primer
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="module0.html">
  Module 0 - Fundamentals
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="module1.html">
  Module 1 - Auto-Differentiation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="module2.html">
  Module 2 - Tensors
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="module3.html">
  Module 3 - Efficiency
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="module4.html">
  Module 4 - Networks
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <p class="caption">
 <span class="caption-text">
  Guides
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Parallel Computation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="matrixmult.html">
   Fusing Operations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cuda.html">
   GPU Programming
  </a>
 </li>
</ul>

  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#numba-jit">
   Numba JIT
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="parallel-computation">
<h1>Parallel Computation<a class="headerlink" href="#parallel-computation" title="Permalink to this headline">¶</a></h1>
<p>The major technique we will use to speed up computation is
parallelization. General parallel code can be difficult to write and
get correct. However, we can again take advantage of the fact that we
have structured our infrastructure around a set of core, general
operations that are used throughout the codebase.</p>
<p>Let's start by going back to <a class="reference internal" href="module0.html"><span class="doc">Module 0 - Fundamentals</span></a> and our <cite>map</cite> operation:</p>
<span class="target" id="module-minitorch.operators.map"></span><p>Higher-order map.</p>
<img alt="_images/maplist.png" src="_images/maplist.png" />
<p>See <a class="reference external" href="https://en.wikipedia.org/wiki/Map_(higher-order_function)">https://en.wikipedia.org/wiki/Map_(higher-order_function)</a></p>
<dl class="field-list simple">
<dt class="field-odd">param fn</dt>
<dd class="field-odd"><p>Function from one value to one value.</p>
</dd>
<dt class="field-even">type fn</dt>
<dd class="field-even"><p>one-arg function</p>
</dd>
<dt class="field-odd">returns</dt>
<dd class="field-odd"><p>A function that takes a list, applies <cite>fn</cite> to each element, and returns a
new list</p>
</dd>
<dt class="field-even">rtype</dt>
<dd class="field-even"><p>function</p>
</dd>
</dl>
<p>There are many ways to implement this function. Let's consider a version where
we pass it an explict output list to fill in. Here's a simple implementation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_map</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">_map</span>
</pre></div>
</div>
<p>This function produces the correct result, but it's not very
efficient. Ideally, we could do something fast to take advantage of
the fact that all the function calls are identical. Also, we shouldn't
have to loop over the list one value at a time. By definition, <cite>map</cite>
(and <cite>zipWith</cite>) can be fast and parallelized, since none of the
individual computations interact with each other.</p>
<p>Python itself doesn't have great fuctions for fast math and parallelism
built-in, but luckily it has good libraries to help speed up numerical
computation. We will utilize one of these libraries known as <a class="reference external" href="http://numba.pydata.org/">Numba</a>.</p>
<div class="section" id="numba-jit">
<h2>Numba JIT<a class="headerlink" href="#numba-jit" title="Permalink to this headline">¶</a></h2>
<p>Numba is a numerical JIT compiler for python. When a function is first
created, it
converts raw Python code to faster numerical operations under the hood. We
have seen an example of this library earlier when developing our mathematical
operators:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">neg</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">x</span>
</pre></div>
</div>
<p>This JIT function alone does not make the code much faster, but it allows
us to use
this code within other code. For instance, if we want to improve our <cite>map</cite>
implementation, we can change it to look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>
<span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="c1"># Change 1: Move function from Python to JIT version.</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">njit</span><span class="p">()(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_map</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># Change 2: Internal _map must be JIT version as well.</span>
    <span class="k">return</span> <span class="n">njit</span><span class="p">()(</span><span class="n">_map</span><span class="p">)</span>

<span class="c1"># Note that all JIT happens when outer map is first called.</span>
<span class="n">neg_map</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">neg</span><span class="p">)</span>
</pre></div>
</div>
<p>When the above function is called, instead of running slow Python code, it will
run fast low-level code that takes advantage of the structure. This approach
requires a bit of overhead on startup, but can make things much faster.</p>
<p>Furthermore, if we know that the loop can be done in parallel, we can speed
it up further with one small change:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">prange</span>
<span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">njit</span><span class="p">()(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_map</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="c1"># Change 3: Run the loop in parallel (prange)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">_map</span><span class="p">)</span>
</pre></div>
</div>
<p>What's neat about this is that the above code is basically the same as
the Python code without paralelization. You can switch back and forth
between the two without much change.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You have to be a bit careful to ensure that the loop actually can be
parallelized.
In short, this means that steps cannot depend on each other and
each iteration cannot write to the same output value.
For instance, when implementing <cite>reduce</cite>, you have to be careful to mix
parallel and
non-parallel loops.</p>
</div>
<p>For full details on how Numba works, read this <a class="reference external" href="https://numba.pydata.org/numba-doc/latest/user/parallel.html">tutorial</a>.</p>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="module3.html" title="previous page">Module 3 - Efficiency</a>
    <a class='right-next' id="next-link" href="matrixmult.html" title="next page">Fusing Operations</a>

              </div>
              
          </main>
          

      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2020, Sasha Rush.<br/>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.0.<br/>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>